require('dotenv').config();
const express = require('express');
const cors = require('cors');
const OpenAI = require('openai').OpenAI;

const app = express();

app.use(cors());
app.use(express.json({ limit: '50mb' }));

console.log('OPENAI_API_KEY ì¡´ìž¬ ì—¬ë¶€:', !!process.env.OPENAI_API_KEY);

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

app.post('/poem', async (req, res) => {
  try {
    const { imageBase64, moodTag, story } = req.body;

    if ((!imageBase64 && (!story || story.trim() === '')) && (!moodTag || moodTag.trim() === '')) {
      return res.status(400).json({ error: 'ì‚¬ì§„, ì‚¬ì—°, ê°ì • ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    // ê°ì • ì ìˆ˜ ëŒ€ì‹  moodTag(ê¸°ë¶„ íƒœê·¸) ì„¤ëª… í¬í•¨

const promptSystem = `
ë„ˆëŠ” í•œêµ­ì˜ ì‹¤ì œ ì‹œë¥¼ ì¶”ì²œí•˜ëŠ” ì „ë¬¸ ì‹œì¸ ì—­í• ì´ë‹¤.

ë‹¤ìŒ ì¡°ê±´ì„ ë°˜ë“œì‹œ ì§€ì¼œë¼:

1. ë°˜ë“œì‹œ ì‹¤ì œë¡œ ì¡´ìž¬í•˜ëŠ” í•œêµ­ ì‹œë§Œ ì¶”ì²œí•  ê²ƒ.
   - ë°˜ë“œì‹œ êµ­ë¦½ì¤‘ì•™ë„ì„œê´€, í•œêµ­ë¯¼ì¡±ë¬¸í™”ëŒ€ë°±ê³¼ì‚¬ì „, ì €ìž‘ê¶Œìœ„ì›íšŒ ê³µìœ ë§ˆë‹¹, í•œêµ­í˜„ëŒ€ë¬¸í•™ê´€, ì‹œì§‘ ì›ë¬¸, ê³µì‹ ë¬¸í•™ ì‚¬ì´íŠ¸ ë“±ì—ì„œ í™•ì¸ëœ ì‹œë§Œ ì¶”ì²œí•  ê²ƒ.
   - ì‹œë¥¼ ìž„ì˜ë¡œ ì°½ìž‘í•˜ê±°ë‚˜ ë³€í˜•í•˜ëŠ” ê²ƒì„ ì ˆëŒ€ ê¸ˆì§€í•œë‹¤.

2. ë°˜ë“œì‹œ ì•„ëž˜ ì„¸ ê°€ì§€ ì •ë³´ë¥¼ ëª¨ë‘ ê³ ë ¤í•˜ì—¬ ì‹œì˜ 'ì£¼ì œ'ë¥¼ ì„ ì •í•  ê²ƒ.
   - ì‚¬ì§„: ë°˜ë“œì‹œ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•  ê²ƒ. (ì‚¬ì§„ì—ì„œ ë³´ì´ëŠ” ì‚¬ë¬¼, ìƒ‰ê°, ë¶„ìœ„ê¸°, ê³„ì ˆ, ë°°ê²½, ëª…í™•í•œ ì£¼ì œë¥¼ ì¤‘ì ìœ¼ë¡œ íŒë‹¨)
   - ì‚¬ì—°: ì‚¬ì§„ê³¼ ì–´ìš¸ë¦¬ëŠ”ì§€ ë³´ì¡°ì ìœ¼ë¡œ ê³ ë ¤í•  ê²ƒ.
   - ê¸°ë¶„ íƒœê·¸: ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•  ê²ƒ. ì¤‘ìš”ë„ëŠ” ë§¤ìš° ë‚®ìŒ.

   ðŸ‘‰ ì‚¬ì§„ì„ ê±°ì˜ ì ˆëŒ€ì ìœ¼ë¡œ ê³ ë ¤í•˜ë˜, ì‚¬ì—°ì€ ë¶€ì°¨ì  ížŒíŠ¸ë¡œ, ê¸°ë¶„ íƒœê·¸ëŠ” ë¶„ìœ„ê¸° ë³´ì¡° ìˆ˜ì¤€ìœ¼ë¡œë§Œ ë°˜ì˜í•  ê²ƒ.

3. ì‚¬ì§„, ì‚¬ì—°, ê¸°ë¶„ íƒœê·¸ë¥¼ ëª¨ë‘ ê³ ë ¤í•˜ë˜, ë°˜ë“œì‹œ ì‚¬ì§„ì˜ ì£¼ì œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê´€ë ¨ëœ ì‹œë¥¼ ì¶”ì²œí•  ê²ƒ.
   - ì‚¬ì§„ê³¼ ê°€ìž¥ ê´€ë ¨ì„±ì´ ë†’ì€ ì‹œë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ì¶”ì²œí•´ì•¼ í•œë‹¤.
   - ì‚¬ì—°ì€ ì‚¬ì§„ ì£¼ì œì™€ ì–´ìš¸ë¦¬ëŠ”ì§€ í™•ì¸í•˜ëŠ” ìš©ë„ë¡œ í™œìš©í•œë‹¤.
   - ê¸°ë¶„ íƒœê·¸ëŠ” ì°¸ê³ ë§Œ í•œë‹¤.

4. ë§Œì•½ ì‚¬ì§„ê³¼ ì§ì ‘ì ìœ¼ë¡œ ì¼ì¹˜í•˜ëŠ” ì‹œê°€ ì—†ì„ ê²½ìš°, ë¶„ìœ„ê¸°, ê³„ì ˆ, ê°ì • ë“±ì—ì„œ ìžì—°ìŠ¤ëŸ½ê²Œ ì–´ìš¸ë¦¬ëŠ” ì‹œë¥¼ ì¶”ì²œí•  ê²ƒ.

5. ì €ìž‘ê¶Œì´ ë§Œë£Œëœ ì‹œ(1950ë…„ëŒ€ ì´ì „ ì¶œíŒ ì‹œì§‘ ìˆ˜ë¡ ì‹œ)ëŠ” ë°˜ë“œì‹œ ì‹œ ì „ë¬¸ ì „ì²´ë¥¼ ì¸ìš©í•  ê²ƒ.

6. ì €ìž‘ê¶Œì´ ìœ íš¨í•œ ì‹œëŠ” ë°˜ë“œì‹œ ê³µì‹ ìžë£Œì—ì„œ í™•ì¸ëœ ì¼ë¶€(í•œ ì—° ë˜ëŠ” 3~5ì¤„ ì´ë‚´)ë§Œ ì¸ìš©í•  ê²ƒ.

7. ì €ìž‘ê¶Œì´ ìœ íš¨í•˜ì—¬ ì¼ë¶€ë§Œ ì¸ìš©í•œ ê²½ìš°, 'ì„¤ëª…' ì•ˆì— "ë³¸ ì‹œëŠ” ì €ìž‘ê¶Œ ë³´í˜¸ë¥¼ ìœ„í•´ ì¼ë¶€ë§Œ ì¸ìš©í•˜ì˜€ìŠµë‹ˆë‹¤."ë¼ëŠ” ë¬¸ìž¥ì„ ë°˜ë“œì‹œ ìžì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•  ê²ƒ.  
   (ë‹¨, ì ˆëŒ€ë¡œ ì‹œ ì œëª© ì•ž, ì‹œ ë³¸ë¬¸ ì•ž, ì‹œì™€ ì„¤ëª… ì‚¬ì´ì— ì´ ë¬¸êµ¬ë¥¼ ë„£ì–´ì„œëŠ” ì•ˆ ëœë‹¤. ë°˜ë“œì‹œ 'ì„¤ëª…' ì•ˆì—ë§Œ í¬í•¨í•´ì•¼ í•œë‹¤.)

8. ë°˜ë“œì‹œ ì•„ëž˜ì˜ ì¶œë ¥ ìˆœì„œë¥¼ ì² ì €ížˆ ì§€í‚¬ ê²ƒ. ì¶œë ¥ ìˆœì„œê°€ ì–´ê¸‹ë‚˜ë©´ ì˜¤ë‹µìœ¼ë¡œ ê°„ì£¼í•œë‹¤:
   - ë°˜ë“œì‹œ ì²« ì¤„: ì‹œ ì œëª© (ì‹œ ì œëª©ë§Œ)
   - ë°˜ë“œì‹œ ë‘˜ì§¸ ì¤„: ì‹œì¸ ì´ë¦„ (ì‹œì¸ ì´ë¦„ë§Œ)
   - ë°˜ë“œì‹œ ì…‹ì§¸ ì¤„ë¶€í„°: ì‹œ ë³¸ë¬¸ (ê° í–‰ì€ \\n ìœ¼ë¡œ ì¤„ë°”ê¿ˆ, ì—°ê³¼ ì—° ì‚¬ì´ëŠ” ë°˜ë“œì‹œ \\n\\n ìœ¼ë¡œ êµ¬ë¶„)
   - ì‹œ ë³¸ë¬¸ì´ ëë‚œ í›„ ë°˜ë“œì‹œ ë¹ˆ ì¤„ í•œ ì¤„ì„ í¬í•¨í•  ê²ƒ.
   - ê·¸ ë‹¤ìŒ: ì„¤ëª… (ì‹œì™€ ì„¤ëª… ì‚¬ì´ ë°˜ë“œì‹œ ë¹ˆ ì¤„ í¬í•¨)
   - ì„¤ëª… ë§ˆì§€ë§‰ ì¤„ì— ë°˜ë“œì‹œ ì¶œì²˜ë¥¼ ëª…ì‹œí•  ê²ƒ. (ì¶œì²˜: ì‹œì§‘ëª…, ë°œí‘œ ì—°ë„, ê³µì‹ ë¬¸í•™ ì‚¬ì´íŠ¸ ì£¼ì†Œ ë“± ì‹¤ì œ í™•ì¸ ê°€ëŠ¥í•œ ì •ë³´ í¬í•¨)

9. ì‹œ ì„¤ëª…ì—ëŠ” ë°˜ë“œì‹œ ì•„ëž˜ë¥¼ í¬í•¨í•  ê²ƒ:
   - ì‹œì™€ ì‚¬ì§„ì´ ì–´ë–»ê²Œ ì–´ìš¸ë¦¬ëŠ”ì§€ 'ì‚¬ì§„ ì¤‘ì‹¬'ìœ¼ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•  ê²ƒ.
   - ì‚¬ì—°ê³¼ ê¸°ë¶„ íƒœê·¸ëŠ” ë¶€ê°€ì ìœ¼ë¡œ ì„¤ëª…í•  ê²ƒ.
   - ì €ìž‘ê¶Œ ë³´í˜¸ ë¬¸êµ¬ëŠ” ë°˜ë“œì‹œ ì„¤ëª… ì•ˆì— ìžì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•  ê²ƒ.

10. ì„¤ëª…ê³¼ ì‹œê°€ ì ˆëŒ€ ì„žì´ì§€ ì•Šë„ë¡ ìž‘ì„±í•  ê²ƒ. ì¶œë ¥ í˜•ì‹ì„ ì² ì €ížˆ ì§€í‚¬ ê²ƒ. ì¶œë ¥ í˜•ì‹ì´ ì–´ê¸‹ë‚˜ë©´ ì˜¤ë‹µìœ¼ë¡œ ê°„ì£¼ëœë‹¤.

11. ë°˜ë“œì‹œ ì¶œë ¥ í˜•ì‹ì—ì„œ ì•„ëž˜ 4ê°€ì§€ê°€ ì •í™•ížˆ ë§žì•„ì•¼ ì •ë‹µì´ë‹¤:
   - ì²« ì¤„: ì‹œ ì œëª© (ì ˆëŒ€ ë‹¤ë¥¸ ë‚´ìš© ê¸ˆì§€)
   - ë‘˜ì§¸ ì¤„: ì‹œì¸ ì´ë¦„ (ì ˆëŒ€ ë‹¤ë¥¸ ë‚´ìš© ê¸ˆì§€)
   - ì‹œ ë³¸ë¬¸ì€ ë°˜ë“œì‹œ 3ë²ˆì§¸ ì¤„ë¶€í„° ì‹œìž‘
   - ì‹œì™€ ì„¤ëª…ì€ ë°˜ë“œì‹œ ë¹ˆ ì¤„ í•œ ì¤„ë¡œ êµ¬ë¶„

12. ë§í¬, ì½”ë“œë¸”ë¡, ë”°ì˜´í‘œ ë“± íŠ¹ìˆ˜ë¬¸ìžëŠ” í¬í•¨í•˜ì§€ ë§ ê²ƒ.

13. ì‚¬ëžŒ ê´€ë ¨ ì •ë³´(ì–¼êµ´, ë‚˜ì´, ì„±ë³„ ë“±)ëŠ” ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ë§ ê²ƒ.

14. ë°˜ë“œì‹œ ì•„ëž˜ ì˜ˆì‹œ ë‹µë³€ í˜•ì‹ì„ ì •í™•ížˆ ë”°ë¼ì•¼ í•œë‹¤.

ì•„ëž˜ëŠ” ì˜ˆì‹œ ë‹µë³€ í˜•ì‹ì´ë‹¤:

ì„œì‹œ  
ìœ¤ë™ì£¼  
ì£½ëŠ” ë‚ ê¹Œì§€ í•˜ëŠ˜ì„ ìš°ëŸ¬ëŸ¬\\ní•œ ì  ë¶€ë„ëŸ¼ì´ ì—†ê¸°ë¥¼.\\nìžŽìƒˆì— ì´ëŠ” ë°”ëžŒì—ë„\\në‚˜ëŠ” ê´´ë¡œì›Œí–ˆë‹¤.\\n\\n

ì´ ì‹œëŠ” ìžì‹ ì˜ ì‚¶ì„ ì„±ì°°í•˜ë©° ì£¼ì–´ì§„ ê¸¸ì„ ë¬µë¬µížˆ ê±¸ì–´ê°€ê² ë‹¤ëŠ” ë‹¤ì§ì„ ë‹´ê³  ìžˆìŠµë‹ˆë‹¤.  
ì‚¬ì§„, ë‹¹ì‹ ì˜ ê¸°ë¶„, ì‚¬ì—°ì„ ë°˜ì˜í•˜ì—¬, ì‚¬ì§„ì„ ì˜¬ë¦° ë¶„ê»˜ë„ ì´ ì‹œì²˜ëŸ¼ íž˜ë“¤ê³  ì–´ë ¤ìš´ ìƒí™© ì†ì—ì„œë„ í”ë“¤ë¦¬ì§€ ì•Šê³  ì•žìœ¼ë¡œ ë‚˜ì•„ê°€ê¸¸ ì‘ì›í•©ë‹ˆë‹¤. ë³¸ ì‹œëŠ” ì €ìž‘ê¶Œ ë³´í˜¸ë¥¼ ìœ„í•´ ì¼ë¶€ë§Œ ì¸ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.  
ì¶œì²˜: ì‹œì§‘ ã€Ží•˜ëŠ˜ê³¼ ë°”ëžŒê³¼ ë³„ê³¼ ì‹œã€, 1948ë…„, ì •ìŒì‚¬
`;

const messages = [
  { role: 'system', content: promptSystem },
  {
    role: 'user',
    content: [
      {
        type: 'text',
        text:
          'ì´ ì´ë¯¸ì§€ë¥¼ ë³´ê³  ì‚¬ë¬¼, ìƒ‰ê°, ë¶„ìœ„ê¸°ë¥¼ ë¶„ì„í•˜ì—¬ ê°€ìž¥ ì–´ìš¸ë¦¬ëŠ” í•œêµ­ì˜ ì‹¤ì œ ì¡´ìž¬í•˜ëŠ” ì‹œë¥¼ ì¶”ì²œí•´ì¤˜. ' +
          'ì‚¬ëžŒ ê´€ë ¨ ì •ë³´ëŠ” ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ë§ê³ , ì‚¬ëžŒì€ ì¡´ìž¬í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  ê°€ì •í•  ê²ƒ. ' +
          'ë§í¬ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ ê²ƒ. ' +
          'ì‚¬ì§„, ì‚¬ì—°, ê¸°ë¶„ íƒœê·¸ ìˆœì„œëŒ€ë¡œ ì¤‘ìš”ë„ë¥¼ ì„¤ì •í•˜ì—¬ ì‹œë¥¼ ì¶”ì²œí•˜ê³ , ì£¼ì œê°€ ì§ì ‘ì ìœ¼ë¡œ ì¼ì¹˜í•˜ì§€ ì•Šì„ ê²½ìš° ë¶„ìœ„ê¸°, ê³„ì ˆ, ê°ì • ë“± ë¶€ì°¨ì  ìš”ì†Œë¥¼ ê³ ë ¤í•  ê²ƒ. ' +
          'ê¸°ë¶„ íƒœê·¸ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ê³ ë ¤í•  ê²ƒ. ' +
          'ì €ìž‘ê¶Œì´ ë§Œë£Œëœ ì‹œëŠ” ì „ë¬¸ ì „ì²´ë¥¼, ì €ìž‘ê¶Œì´ ìœ íš¨í•œ ì‹œëŠ” ì¼ë¶€ë§Œ ì¸ìš©í•  ê²ƒ. ' +
          'ì¼ë¶€ë§Œ ì¸ìš©í•œ ê²½ìš°, ì„¤ëª… ì•ˆì— "ë³¸ ì‹œëŠ” ì €ìž‘ê¶Œ ë³´í˜¸ë¥¼ ìœ„í•´ ì¼ë¶€ë§Œ ì¸ìš©í•˜ì˜€ìŠµë‹ˆë‹¤."ë¼ëŠ” ë¬¸ìž¥ì„ ë°˜ë“œì‹œ ìžì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•  ê²ƒ. ' +
          'ë‹¨, ì‹œ ì œëª© ì•ž, ì‹œ ë³¸ë¬¸ ì•ž, ì‹œì™€ ì„¤ëª… ì‚¬ì´ì— ì´ ë¬¸êµ¬ë¥¼ ì ˆëŒ€ ë„£ì–´ì„œëŠ” ì•ˆ ëœë‹¤.' +
          'ì¶œë ¥ ìˆœì„œëŠ” ë°˜ë“œì‹œ ì‹œ ì œëª© â†’ ì‹œì¸ ì´ë¦„ â†’ ì‹œ ë³¸ë¬¸ â†’ (ë¹ˆ ì¤„) â†’ ì„¤ëª… â†’ ì¶œì²˜ ìˆœì„œë¥¼ ì§€ì¼œì•¼ í•œë‹¤.' +
          `ë‹¹ì‹ ì˜ ê¸°ë¶„ íƒœê·¸ëŠ” "${moodTag}"ìž„ì„ ì°¸ê³ í•˜ë¼.` +
          `ë‹¹ì‹ ì˜ í˜„ìž¬ ì‚¬ì—°ì€ "${story}"ìž„ì„ ì°¸ê³ í•˜ë¼.`,
      },
    ],
  },
];


    if (imageBase64) {
      messages[1].content.push({ type: 'image_url', image_url: { url: imageBase64 } });
    }

    const completion = await openai.chat.completions.create({
      model: 'gpt-4o',
      temperature: 0.7,
      messages,
    });

    console.log('GPT ì‘ë‹µ:', completion.choices[0].message.content);

    res.json({ poem: completion.choices[0].message.content });
  } catch (error) {
    console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
    res.status(500).json({ error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

const port = process.env.PORT || 3001;
app.listen(port, '0.0.0.0', () => {
  console.log(`ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${port}`);
});